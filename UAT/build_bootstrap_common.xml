<project name="IIB-CI-BOOTSTRAP" default="bootstrap" basedir="..">
  <description>IIB Continuous Integration (bootstrap script)</description>

	<property environment="env" />
	<property name="APPNAME" value = ""/>
	<property name = "IIBSVR1" value =""/>
	<property name = "IIBSVR2" value =""/>
	<property name = "IIBSVR3" value =""/>
	<property name = "IIBSVR4" value =""/>
	<property name = "IIBSVR5" value =""/>
	<property name = "IIBSVR6" value =""/>
	<property name = "IIBSVR7" value =""/>
	<property name = "IIBSVR8" value =""/>
	<property name = "IIBSVR9" value =""/>
	
  <target name="bootstrap_init">
    <tstamp />
    <property environment="env" />
    <property name="path.build" value="UAT" />
    <property name="build.main" value="${path.build}/build_common.xml" />
    <property file="${path.build}/build.properties" />
    <exec executable="id" />
  </target>
	
  <target name="bootstrap" depends="bootstrap_init">
    <property name="wkspc.owner" value="${user.iib}:${group.iib}" />
    <property name="wkspc.mode" value="go+rw" />

    <!-- update workspace permissions -->
    <!-- https://wiki.jenkins-ci.org/display/JENKINS/Building+a+software+project#Buildingasoftwareproject-JenkinsSetEnvironmentVariables -->
    <exec executable="sudo">
      <arg value="-n" />
      <arg value="sh" />
      <arg value="-c" />
      <arg value="chown -R ${wkspc.owner} ${env.WORKSPACE}; chmod -R ${wkspc.mode} ${env.WORKSPACE}" />
    </exec>

    <!-- call Ant with build_main.xml as another user in a new shell -->
    <!-- https://ant.apache.org/manual/running.html -->
    <fileset dir="${ant.library.dir}" id="ant.jar.files">
      <include name="**/*.jar"/>
    </fileset>
    <pathconvert pathsep=":" property="jars.ant" refid="ant.jar.files"/>
    <property name="ext.dirs" value="${path.iib}/common/jdk/lib:${path.iib}/common/jdk/jre/lib/ext" />
    <property name="args.jvm" value="-cp $CLASSPATH:$MQSI_JREPATH/${jars.ant} -Djava.ext.dirs=${ext.dirs} -Dant.home=${ant.home} ${ant.main.class} -Dapp.name=${APPNAME} -Denv.wrksp=${env.WORKSPACE} -Diib.svr1=${IIBSVR1} -Diib.svr2=${IIBSVR2} -Diib.svr3=${IIBSVR3} -Diib.svr4=${IIBSVR4} -Diib.svr5=${IIBSVR5} -Diib.svr6=${IIBSVR6} -Diib.svr7=${IIBSVR7}" />
    <property name="args.ant" value="-f ${build.main}" />
    <property name="init.env" value=". ${iib.mqsiprofile}" />

    <exec executable="sudo">
      <arg value="-n" />
      <arg value="-u" />
      <arg value="${user.iib}" />
      <arg value="sh" />
      <arg value="--login" />
      <arg value="-c" />
      <arg value="${init.env}; $MQSI_JREPATH/bin/java ${args.jvm} ${args.ant}" />
    </exec>
  </target>
</project>
